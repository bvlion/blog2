<!doctype html><html lang=ja-jp><head><title>オンプレから PaaS への移行 | 鰯の管詰</title>
<meta charset=utf-8><meta name=viewport content="width=device-width,initial-scale=1,viewport-fit=cover"><link rel=canonical href=https://www.ambitious-i.net/blog/on_premises_server_to_heroku/><link rel=apple-touch-icon sizes=180x180 href=https://www.ambitious-i.net/image/favicons/apple-touch-icon.png><link rel=icon type=image/png sizes=32x32 href=https://www.ambitious-i.net/image/favicons/favicon-32x32.png><link rel=icon type=image/png sizes=16x16 href=https://www.ambitious-i.net/image/favicons/favicon-16x16.png><link rel=manifest href=https://www.ambitious-i.net/image/favicons/site.webmanifest><link rel=mask-icon href=https://www.ambitious-i.net/image/favicons/safari-pinned-tab.svg color=#999999><meta name=msapplication-TileColor content="#da532c"><meta name=theme-color content="#ffffff"><meta name=description content="
    これまで家のラズパイで動かしてたバッチ的なモジュールの一部を Heroku に移行した時のことを書きたいと思います！
    "><meta property="og:description" content="
    これまで家のラズパイで動かしてたバッチ的なモジュールの一部を Heroku に移行した時のことを書きたいと思います！
    "><meta property="og:image" content="https://www.ambitious-i.net/blog/on_premises_server_to_heroku/head.jpg"><meta property="og:title" content="オンプレから PaaS への移行"><meta property="og:type" content="article"><meta property="og:url" content="https://www.ambitious-i.net/blog/on_premises_server_to_heroku/"><meta property="article:section" content="blog"><meta property="article:published_time" content="2019-10-02T00:00:00+00:00"><meta property="article:modified_time" content="2019-10-02T00:00:00+00:00"><meta name=twitter:card content="summary"><meta name=twitter:title content="オンプレから PaaS への移行"><meta name=twitter:description content="これまで家のラズパイで動かしてたバッチ的なモジュールの一部を Heroku に移行した時のことを書きたいと思います！"><meta itemprop=name content="オンプレから PaaS への移行"><meta itemprop=description content="これまで家のラズパイで動かしてたバッチ的なモジュールの一部を Heroku に移行した時のことを書きたいと思います！"><meta itemprop=datePublished content="2019-10-02T00:00:00+00:00"><meta itemprop=dateModified content="2019-10-02T00:00:00+00:00"><meta itemprop=wordCount content="168"><meta itemprop=keywords content="サービス,技術,Heroku"><link rel=stylesheet href=https://www.ambitious-i.net/main.min.css><script src=https://www.ambitious-i.net/bundle.js></script></head><body><header id=header><div class=top-bar><div class=container-md><div class="row align-items-center"><div class="col-3 col-sm-4 social-buttons d-none d-sm-block"><ul><li><a href=https://x.com/ninjinx target=_blank><i class="fab fa-twitter"></i></a></li><li><a href=https://github.com/bvlion target=_blank><i class="fab fa-github"></i></a></li></ul></div><div class="ra-toggler col-3 col-sm-4 d-block d-sm-none"><button class=bg-dark type=button data-bs-toggle=collapse data-bs-target=#navbarNav>
<i class="fas fa-bars"></i></button></div><div class="col-6 col-sm-4"><h2 class=title><a href=https://www.ambitious-i.net/>鰯の管詰</a></h2></div><div class="col-3 col-sm-4"><div class="col col-md-8 offset-md-4 d-none d-sm-block"><form id=cse-search-box-form-id class="input-group search-bar" onsubmit=return!1 role=search><input id=cse-search-input-box-id2 type=text class=form-control placeholder=Search onkeyup=handleKeyPress(event)>
<button class=btn type=submit onclick=searchBlog()>
<i class="fa fa-search"></i></button></form></div></div></div></div></div><div class=container-md><nav class="navbar navbar-expand-sm navbar-dark bg-dark"><div class="collapse navbar-collapse" id=navbarNav><ul class="navbar-nav mx-auto"><li class="nav-item d-block d-sm-none"><ul class=social-buttons><ul><li><a href=https://x.com/ninjinx target=_blank><i class="fab fa-twitter"></i></a></li><li><a href=https://github.com/bvlion target=_blank><i class="fab fa-github"></i></a></li></ul></ul></li><li class=nav-item><a class=nav-link href=https://www.ambitious-i.net/>Home</a></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown>Blog</a><div class=dropdown-menu><a class=dropdown-item href=https://www.ambitious-i.net/blog/>記事一覧</a>
<a class=dropdown-item href=https://www.ambitious-i.net/tags/>タグ</a></div></li><li class="nav-item dropdown"><a class="nav-link dropdown-toggle" href=# id=navbarDropdown role=button data-bs-toggle=dropdown>About</a><div class=dropdown-menu><a class=dropdown-item href=https://www.ambitious-i.net/person/>本人について</a>
<a class=dropdown-item href=https://www.ambitious-i.net/account/>アカウント</a>
<a class=dropdown-item target=_blank href=https://bvlion-app.web.app>個人活動</a></div></li><li class=nav-item><a class=nav-link target=_blank href=https://forms.gle/dUkf1dNdkgN2ZxJ66>ご意見・ご感想</a></li></ul><form id=cse-search-box-form-id2 class="d-flex search-bar d-block d-sm-none" onsubmit=return!1 role=search><input id=cse-search-input-box-id2 type=text class=form-control placeholder=Search onkeyup=handleKeyPress(event)>
<button class=btn type=submit onclick=searchBlog()>
<i class="fa fa-search"></i></button></form></div></nav></div></header><main class=blog-content><div class=container-md><div class=row><div class="col-md-12 col-lg-12 px-lg-4"><h1 class=title>オンプレから PaaS への移行</h1><div class="container-fluid px-0 mb-4"><div class="row align-items-end"><div class="col-md-4 date-time"><span class=date>2019/10/2
</span>&#183;
<span class=time-to-read>8 mins read</span></div><div class="col-md-8 tags"><a href=https://www.ambitious-i.net/tags/%E3%82%B5%E3%83%BC%E3%83%93%E3%82%B9><span class="tag bg-dark">サービス</span></a>
<a href=https://www.ambitious-i.net/tags/%E6%8A%80%E8%A1%93><span class="tag bg-dark">技術</span></a>
<a href=https://www.ambitious-i.net/tags/heroku><span class="tag bg-dark">Heroku</span></a></div></div></div><div class=error-border><strong class="dark-red one-year-ago">※ この記事は公開されてから1年以上経過しているため、情報が古い可能性があります。</strong></div><figure><img id=cover-image src=https://www.ambitious-i.net/blog/on_premises_server_to_heroku/head.jpg alt="オンプレから PaaS への移行"></figure><p>今まではオンプレミス（ラズパイ）で家の色んなバッチを動かしてきていました！
一例だけでもこんな感じです…</p><ul><li>motion による監視カメラ</li><li>在宅通知（監視カメラを住人在宅時は動作させない）</li><li>Twitter 徘徊（Jorudan とか）</li><li>Google Home と連動した時間通知（平日の朝）</li><li>赤外線のタイマー（祝日判定付き）</li><li>記念日通知</li><li>個人の Slack に占い通知（<a href=http://jugemkey.jp/api/waf/api_free.php>Web ad Fortune</a> 利用）</li><li>目覚まし設定通知（休みや平日の前）</li><li>曜日指定の忘れ防止通知</li><li>Google Home Notifier と連動した YouTube 上の音楽の再生</li></ul><p>処理内容自体はそこまででもないのですが、これだけ動かしているとラズパイにも家のトラフィックにもかなり負荷があるため、何とか無料の PaaS 系に移行できないかと考えておりました。<br>そこで目をつけたのが以前より使い捨てマークダウン等でお世話になっている Heroku です(･∀･)<br>GAE も考えたのですが、ちょっと負荷が高いと簡単にインスタンスが立ち上がるという記事を目にしていたため、GAE は断念しました(^^;<br>（違うアプリでちょっとだけ導入しています）</p><p>そして紆余曲折あって、無事に今は安定稼働となりました！<br>今回は、移行に際し色々と詰まったりしたことを上げていきたいと思います(*･ω･)ﾉ</p><h2 id=時刻は-utc>時刻は UTC</h2><p>当然ですが、時刻は UTC です。。。<br>元々自宅（日本）で動かしていたので、全部 9 時間ズレました(笑)<br>粛々と Calendar クラスや Formatter 系に Timezone を設定しました。<br>多分漏れはないはず…</p><h2 id=caused-by-javasqlsqlsyntaxerrorexception-user-hoge-has-exceeded-the-max_questions-resource-current-value-3600>Caused by: java.sql.SQLSyntaxErrorException: User &lsquo;hoge&rsquo; has exceeded the &lsquo;max_questions&rsquo; resource (current value: 3600)</h2><p>運用開始早々に出ました(´･ω･`)<br>何のことかと思って調べてみると、Heroku の無料版 ClearDB では <strong>SQL クエリ数の上限が 3,600 に設定されている</strong>ようです＿|￣|○<br>Spring Batch も併用しているため管理テーブルの使用などで、物凄いクエリ数なようです。<br><strong>秒で</strong>発生しました∑(￣□￣|||)<br>元々ラズパイで運用していた時も、このブログが運用されている XServer の MySQL を SSH 経由で利用していたので、ClearDB は諦め元の方法に戻しました。<br>Heroku からも SSH 経由で使えてよかった…</p><h2 id=springboot-の-scheduledcron-がいい加減>Springboot の Scheduled(cron) がいい加減</h2><p>この理由は実はまだ分かっていません(^ω^;)</p><pre tabindex=0><code>@Scheduled(cron = &#34;0 30 7 * * *&#34;, zone = &#34;Asia/Tokyo&#34;)
</code></pre><p>と設定しても、7:30 ではなく 7:52 だったり 7:44 だったりまちまちですw<br>なので時間通知のような正確なものはエンドポイントを用意し、curl で突く方法に変更しました。</p><h2 id=google-calendar-api-でエラー>Google Calendar API でエラー</h2><p>Google Calendar API を使って祝日判定をさせていたのですが、どうもうまく動きません。<br>ログを確認してみたところ、403 Forbidden が返ってきています(^^;<br>え？と思い Paiza で試してみると、こちらでも同様の事象が発生しました。<br>海外から日本の祝日は取得できないということでしょうか？<br>これはまだ残っているラズパイに実施させ、結果登録のエンドポイントを用意することで対応しました。</p><h2 id=new-relic-の導入>New Relic の導入</h2><p>導入方法は Qiita に <a href=https://qiita.com/bvlion/items/9c069074bd6e84473a2e>Heroku で動かす Java アプリに New Relic を導入する</a>というタイトルで記載しましたので、詳細はそちらをご参照ください。<br>せっかくなので状態監視とか入れようと思ったのですが、Qiita の最後にも記載した通り、思ってた以上にメモリを使うようです(>_&lt;)<br>当初は導入から 45 分で終了しましたw</p><h2 id=残ったもの>残ったもの</h2><p>さすがに監視カメラは家に設置しますし、youtube-dl や Google Home Notifier など家のサーバーでないと出来ないものは残りました。<br>ただポート解放はやめ、Firebase Realtime Database を Node から利用することで外から喋らせたり監視カメラの動作を制御したりしています(･∀･)</p><p>何となく便利になればと作ったモジュールたちを当たり前に使っていましたが、いざエラー等で使えなくなるととても不便さを感じましたΣ(･ω･ﾉ)ﾉ<br>エンジニアらしく IT でこれからも生活を豊かに出来たらと思います！</p><div id=social-media-share><div class=share-buttons><a href="https://twitter.com/intent/tweet?text=%e3%82%aa%e3%83%b3%e3%83%97%e3%83%ac%e3%81%8b%e3%82%89%20PaaS%20%e3%81%b8%e3%81%ae%e7%a7%bb%e8%a1%8c&url=https%3a%2f%2fwww.ambitious-i.net%2fblog%2fon_premises_server_to_heroku%2f" onclick='return socialMediaPopUp(this.href,"",500,500),!1' title="Share on Twitter. Opens in a new window."><img src=https://www.ambitious-i.net/icons/45px/twitter-x.png>
</a><a href="https://www.facebook.com/sharer/sharer.php?u=https%3a%2f%2fwww.ambitious-i.net%2fblog%2fon_premises_server_to_heroku%2f" onclick='return socialMediaPopUp(this.href,"",500,500),!1' title="Share on Facebook. Opens in a new window."><img src=https://www.ambitious-i.net/icons/45px/facebook.png>
</a><a href="http://pinterest.com/pin/create/button/?url=https%3a%2f%2fwww.ambitious-i.net%2fblog%2fon_premises_server_to_heroku%2f" onclick='return socialMediaPopUp(this.href,"",900,500),!1' title="Share on Pinterest. Opens in a new window."><img src=https://www.ambitious-i.net/icons/45px/pinterest.png>
</a><a href="https://www.linkedin.com/shareArticle?mini=true&url=https%3a%2f%2fwww.ambitious-i.net%2fblog%2fon_premises_server_to_heroku%2f
			&title=%e3%82%aa%e3%83%b3%e3%83%97%e3%83%ac%e3%81%8b%e3%82%89%20PaaS%20%e3%81%b8%e3%81%ae%e7%a7%bb%e8%a1%8c&summary=%3cp%3e%e4%bb%8a%e3%81%be%e3%81%a7%e3%81%af%e3%82%aa%e3%83%b3%e3%83%97%e3%83%ac%e3%83%9f%e3%82%b9%ef%bc%88%e3%83%a9%e3%82%ba%e3%83%91%e3%82%a4%ef%bc%89%e3%81%a7%e5%ae%b6%e3%81%ae%e8%89%b2%e3%82%93%e3%81%aa%e3%83%90%e3%83%83%e3%83%81%e3%82%92%e5%8b%95%e3%81%8b%e3%81%97%e3%81%a6%e3%81%8d%e3%81%a6%e3%81%84%e3%81%be%e3%81%97%e3%81%9f%ef%bc%81%0a%e4%b8%80%e4%be%8b%e3%81%a0%e3%81%91%e3%81%a7%e3%82%82%e3%81%93%e3%82%93%e3%81%aa%e6%84%9f%e3%81%98%e3%81%a7%e3%81%99%e2%80%a6%3c%2fp%3e%0a%3cul%3e%0a%3cli%3emotion%20%e3%81%ab%e3%82%88%e3%82%8b%e7%9b%a3%e8%a6%96%e3%82%ab%e3%83%a1%e3%83%a9%3c%2fli%3e%0a%3cli%3e%e5%9c%a8%e5%ae%85%e9%80%9a%e7%9f%a5%ef%bc%88%e7%9b%a3%e8%a6%96%e3%82%ab%e3%83%a1%e3%83%a9%e3%82%92%e4%bd%8f%e4%ba%ba%e5%9c%a8%e5%ae%85%e6%99%82%e3%81%af%e5%8b%95%e4%bd%9c%e3%81%95%e3%81%9b%e3%81%aa%e3%81%84%ef%bc%89%3c%2fli%3e%0a%3cli%3eTwitter%20%e5%be%98%e5%be%8a%ef%bc%88Jorudan%20%e3%81%a8%e3%81%8b%ef%bc%89%3c%2fli%3e%0a%3cli%3eGoogle%20Home%20%e3%81%a8%e9%80%a3%e5%8b%95%e3%81%97%e3%81%9f%e6%99%82%e9%96%93%e9%80%9a%e7%9f%a5%ef%bc%88%e5%b9%b3%e6%97%a5%e3%81%ae%e6%9c%9d%ef%bc%89%3c%2fli%3e%0a%3cli%3e%e8%b5%a4%e5%a4%96%e7%b7%9a%e3%81%ae%e3%82%bf%e3%82%a4%e3%83%9e%e3%83%bc%ef%bc%88%e7%a5%9d%e6%97%a5%e5%88%a4%e5%ae%9a%e4%bb%98%e3%81%8d%ef%bc%89%3c%2fli%3e%0a%3cli%3e%e8%a8%98%e5%bf%b5%e6%97%a5%e9%80%9a%e7%9f%a5%3c%2fli%3e%0a%3cli%3e%e5%80%8b%e4%ba%ba%e3%81%ae%20Slack%20%e3%81%ab%e5%8d%a0%e3%81%84%e9%80%9a%e7%9f%a5%ef%bc%88%3ca%20href%3d%22http%3a%2f%2fjugemkey.jp%2fapi%2fwaf%2fapi_free.php%22%3eWeb%20ad%20Fortune%3c%2fa%3e%20%e5%88%a9%e7%94%a8%ef%bc%89%3c%2fli%3e%0a%3cli%3e%e7%9b%ae%e8%a6%9a%e3%81%be%e3%81%97%e8%a8%ad%e5%ae%9a%e9%80%9a%e7%9f%a5%ef%bc%88%e4%bc%91%e3%81%bf%e3%82%84%e5%b9%b3%e6%97%a5%e3%81%ae%e5%89%8d%ef%bc%89%3c%2fli%3e%0a%3cli%3e%e6%9b%9c%e6%97%a5%e6%8c%87%e5%ae%9a%e3%81%ae%e5%bf%98%e3%82%8c%e9%98%b2%e6%ad%a2%e9%80%9a%e7%9f%a5%3c%2fli%3e%0a%3cli%3eGoogle%20Home%20Notifier%20%e3%81%a8%e9%80%a3%e5%8b%95%e3%81%97%e3%81%9f%20YouTube%20%e4%b8%8a%e3%81%ae%e9%9f%b3%e6%a5%bd%e3%81%ae%e5%86%8d%e7%94%9f%3c%2fli%3e%0a%3c%2ful%3e%0a%3cp%3e%e5%87%a6%e7%90%86%e5%86%85%e5%ae%b9%e8%87%aa%e4%bd%93%e3%81%af%e3%81%9d%e3%81%93%e3%81%be%e3%81%a7%e3%81%a7%e3%82%82%e3%81%aa%e3%81%84%e3%81%ae%e3%81%a7%e3%81%99%e3%81%8c%e3%80%81%e3%81%93%e3%82%8c%e3%81%a0%e3%81%91%e5%8b%95%e3%81%8b%e3%81%97%e3%81%a6%e3%81%84%e3%82%8b%e3%81%a8%e3%83%a9%e3%82%ba%e3%83%91%e3%82%a4%e3%81%ab%e3%82%82%e5%ae%b6%e3%81%ae%e3%83%88%e3%83%a9%e3%83%95%e3%82%a3%e3%83%83%e3%82%af%e3%81%ab%e3%82%82%e3%81%8b%e3%81%aa%e3%82%8a%e8%b2%a0%e8%8d%b7%e3%81%8c%e3%81%82%e3%82%8b%e3%81%9f%e3%82%81%e3%80%81%e4%bd%95%e3%81%a8%e3%81%8b%e7%84%a1%e6%96%99%e3%81%ae%20PaaS%20%e7%b3%bb%e3%81%ab%e7%a7%bb%e8%a1%8c%e3%81%a7%e3%81%8d%e3%81%aa%e3%81%84%e3%81%8b%e3%81%a8%e8%80%83%e3%81%88%e3%81%a6%e3%81%8a%e3%82%8a%e3%81%be%e3%81%97%e3%81%9f%e3%80%82%3cbr%3e%0a%e3%81%9d%e3%81%93%e3%81%a7%e7%9b%ae%e3%82%92%e3%81%a4%e3%81%91%e3%81%9f%e3%81%ae%e3%81%8c%e4%bb%a5%e5%89%8d%e3%82%88%e3%82%8a%e4%bd%bf%e3%81%84%e6%8d%a8%e3%81%a6%e3%83%9e%e3%83%bc%e3%82%af%e3%83%80%e3%82%a6%e3%83%b3%e7%ad%89%e3%81%a7%e3%81%8a%e4%b8%96%e8%a9%b1%e3%81%ab%e3%81%aa%e3%81%a3%e3%81%a6%e3%81%84%e3%82%8b%20Heroku%20%e3%81%a7%e3%81%99%28%ef%bd%a5%e2%88%80%ef%bd%a5%29%3cbr%3e%0aGAE%20%e3%82%82%e8%80%83%e3%81%88%e3%81%9f%e3%81%ae%e3%81%a7%e3%81%99%e3%81%8c%e3%80%81%e3%81%a1%e3%82%87%e3%81%a3%e3%81%a8%e8%b2%a0%e8%8d%b7%e3%81%8c%e9%ab%98%e3%81%84%e3%81%a8%e7%b0%a1%e5%8d%98%e3%81%ab%e3%82%a4%e3%83%b3%e3%82%b9%e3%82%bf%e3%83%b3%e3%82%b9%e3%81%8c%e7%ab%8b%e3%81%a1%e4%b8%8a%e3%81%8c%e3%82%8b%e3%81%a8%e3%81%84%e3%81%86%e8%a8%98%e4%ba%8b%e3%82%92%e7%9b%ae%e3%81%ab%e3%81%97%e3%81%a6%e3%81%84%e3%81%9f%e3%81%9f%e3%82%81%e3%80%81GAE%20%e3%81%af%e6%96%ad%e5%bf%b5%e3%81%97%e3%81%be%e3%81%97%e3%81%9f%28%5e%5e%3b%3cbr%3e%0a%ef%bc%88%e9%81%95%e3%81%86%e3%82%a2%e3%83%97%e3%83%aa%e3%81%a7%e3%81%a1%e3%82%87%e3%81%a3%e3%81%a8%e3%81%a0%e3%81%91%e5%b0%8e%e5%85%a5%e3%81%97%e3%81%a6%e3%81%84%e3%81%be%e3%81%99%ef%bc%89%3c%2fp%3e&source=https%3a%2f%2fwww.ambitious-i.net%2f" onclick='return socialMediaPopUp(this.href,"",900,500),!1' title="Share on LinkedIn. Opens in a new window."><img src=https://www.ambitious-i.net/icons/45px/linkedin.png>
</a><a href="mailto:?subject=%e3%82%aa%e3%83%b3%e3%83%97%e3%83%ac%e3%81%8b%e3%82%89%20PaaS%20%e3%81%b8%e3%81%ae%e7%a7%bb%e8%a1%8c&amp;body=Check out this site https%3a%2f%2fwww.ambitious-i.net%2fblog%2fon_premises_server_to_heroku%2f" title="Share via Email. Opens in a new window."><img src=https://www.ambitious-i.net/icons/45px/mail.png></a></div></div></div></div></div></main><footer class="text-center py-4"><p>鰯の管詰 © 2017 bvlion. All rights reserved.</p></footer><script async src="https://cse.google.com/cse.js?cx=google-cse-key"></script><gcse:searchresults-only></gcse:searchresults-only></body></html>